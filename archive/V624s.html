<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CycleTime 24s</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @font-face {
      font-family: 'SonsCondensed';
      src: url('fonts/SonsCondensed-Semibold.ttf') format('truetype');
      font-weight: 600;
    }
    @font-face {
      font-family: 'SonsCondensedExtra';
      src: url('fonts/SonsCondensed-Extrabold.ttf') format('truetype');
      font-weight: 800;
    }
    @font-face {
      font-family: 'Inter';
      src: url('fonts/Inter-Regular.otf') format('opentype');
      font-weight: 400;
    }

    :root {
      --green: #c8ff08;
      --teal:  #005E60;
      --btn-hover: #a6d607;
      --teal-dark: #013d3d;
    }

    html,body {height:100%; margin:0;}
    body {
      background:var(--teal);
      color:white;
      font-family:'SonsCondensed',Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    #banner {
      width:100%;
      height:15vh;
      max-height:180px;
      object-fit:contain;
      background:var(--teal);
      display:block;
    }

    #paleStat, #mouleStat, #typeStat {
      position:absolute;
      left:20px;
      font-size:6vh;
      font-family:'SonsCondensed',sans-serif;
    }
    #paleStat { top:40px; }
    #mouleStat { top:100px; }
    #typeStat { top:160px; cursor:pointer; text-decoration:underline; }

    #stats {
      position:absolute;
      top:40px;
      right:20px;
      font-size:6vh;
      font-family:'SonsCondensed',sans-serif;
      display:grid;
      gap:6px 18px;
    }
    .stat {display:flex; justify-content:flex-end; gap:12px;}
    .label {min-width:10ch; text-align:right; font-weight:600;}
    .value {min-width:12ch; text-align:left; font-weight:600;}
    .target-time {color:var(--green);}

    #main {flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;}
    #timer {
      font-family:'SonsCondensedExtra','Courier New',monospace;
      font-variant-numeric:tabular-nums;
      font-size:50vh;
      min-width:7.05ch;
      text-align:left;
      line-height:1;
      margin:0 auto 2vh auto;
      color:var(--green);
      transition:color .2s ease;
    }
    #timer.red {
      color:red;
      -webkit-text-stroke:4px var(--teal-dark);
      text-shadow:
        -1px -1px 0 var(--teal-dark),
         1px -1px 0 var(--teal-dark),
        -1px  1px 0 var(--teal-dark),
         1px  1px 0 var(--teal-dark);
    }

    #bladeContainer{display:flex; gap:1vw; align-items:center; justify-content:center; margin-top:1vh;}
    #bladeInput {
      font-family:'Inter',sans-serif;
      font-size:2.3vh;
      height:5.5vh; min-height:40px;
      border:none;
      padding:0 1.6vh;
      width:12ch;
      text-align:center;
    }

    button.controlBtn {
      font-family:'Inter',sans-serif;
      font-size:2.3vh;
      height:6.5vh; min-height:40px;
      border-radius:1vh;
      border:none;
      padding:0 1.6vh;
      background:white;
      color:var(--teal);
      cursor:pointer;
    }
    button.controlBtn[disabled]{opacity:1; cursor:not-allowed; background:#888;}
    button.controlBtn:hover:not([disabled]){background:var(--green);}
    #stopBtn{display:none; margin-top:1.5vh;}

    #popupOverlay{position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.55);}
    #popup {
      background:#fff;
      padding:30px 40px;
      border-radius:12px;
      min-width:320px;
      text-align:center;
      font-family:'Inter',sans-serif;
    }
    #popup h2{margin:0 0 18px; font-size:1.4rem; color:#000;}
    #popup input{width:80%; padding:10px; text-align:center; font-size:1rem; border:1px solid #ccc; border-radius:6px;}
    #popup .buttons{margin-top:16px; display:flex; justify-content:center; gap:14px;}
    #popup .buttons button{font-family:'Inter',sans-serif; font-size:1rem; padding:12px 24px; border:none; border-radius:8px; background:#eee; color:var(--teal); cursor:pointer;}
    #popup .buttons button:hover:not([disabled]){background:var(--green);}
    #popup .buttons button:disabled{background:#888; cursor:not-allowed;}
    #popup .msg{margin-top:12px; min-height:1.2em; color:#b00; font-size:.95rem;}
  </style>
</head>
<body>
  <img id="banner" src="images/gebanner3.jpg" alt="GE banner">
  <div id="paleStat">Pale :</div>
  <div id="mouleStat">Moule : 02</div>
  <div id="typeStat">Type : <span id="typeVal"></span></div>

  <div id="stats">
    <div class="stat"><span class="label">Moyenne :</span><span class="value" id="averageVal">--:--:--</span></div>
    <div class="stat"><span class="label">Meilleur :</span><span class="value" id="bestVal">--:--:--</span></div>
    <div class="stat"><span class="label">Objectif :</span><span class="value target-time" id="targetVal">24:00:00</span></div>
  </div>

  <div id="main">
    <div id="timer">00:00:00</div>
    <div id="bladeContainer">
      <input id="bladeInput" type="text" maxlength="4" placeholder="Entrer # Pale Ici">
      <button id="startBtn" class="controlBtn" disabled>Commencer</button>
    </div>
    <button id="stopBtn" class="controlBtn">Stop</button>
  </div>

  <div id="popupOverlay">
    <div id="popup">
      <h2>Veuillez entrer le mot de passe</h2>
      <input id="passwordInput" type="password">
      <div class="buttons">
        <button id="cancelPassword">Annuler</button>
        <button id="confirmPassword" disabled>Confirmer</button>
      </div>
      <div class="msg" id="popupMsg"></div>
    </div>
  </div>

  <script>
    const PASSWORD = "4321";
    const LOCKOUT_SECONDS = 60;

    const TYPE_SETTINGS = {
      "47.3": 24, // seconds
      "62.2": 30
    };

    let selectedType = localStorage.getItem("selectedType") || "47.3";
    let stats = JSON.parse(localStorage.getItem("stats")) || {
      "47.3": {runs:[], count:0},
      "62.2": {runs:[], count:0}
    };

    let startTimestamp = null;
    let timerInterval = null;
    let running = false;
    let alarmPlayed = false;
    let failCount = 0;
    let lockoutUntil = 0;

    const timerEl = document.getElementById("timer");
    const paleStat = document.getElementById("paleStat");
    const averageVal = document.getElementById("averageVal");
    const bestVal = document.getElementById("bestVal");
    const bladeInput = document.getElementById("bladeInput");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const typeVal = document.getElementById("typeVal");
    const typeStat = document.getElementById("typeStat");
    const targetVal = document.getElementById("targetVal");
    const popupOverlay = document.getElementById("popupOverlay");
    const passwordInput = document.getElementById("passwordInput");
    const confirmPassword = document.getElementById("confirmPassword");
    const cancelPassword = document.getElementById("cancelPassword");
    const popupMsg = document.getElementById("popupMsg");

    const alarmSound = new Audio("music/mario.mp3");

    function formatHMS(s){
      let h=String(Math.floor(s/3600)).padStart(2,'0');
      let m=String(Math.floor((s%3600)/60)).padStart(2,'0');
      let sec=String(s%60).padStart(2,'0');
      return `${h}:${m}:${sec}`;
    }

    function updateStats(){
      let runs = stats[selectedType].runs;
      if(runs.length === 0){
        averageVal.textContent="--:--:--";
        bestVal.textContent="--:--:--";
      } else {
        let avg = Math.floor(runs.reduce((a,b)=>a+b,0) / runs.length);
        let best = Math.min(...runs);
        averageVal.textContent = formatHMS(avg);
        bestVal.textContent = formatHMS(best);
      }
      targetVal.textContent = (TYPE_SETTINGS[selectedType] === 24 ? "24:00:00" : "30:00:00");
    }

    function saveStats(){
      localStorage.setItem("stats", JSON.stringify(stats));
      localStorage.setItem("selectedType", selectedType);
    }

    function setType(t){
      selectedType = t;
      typeVal.textContent = t;
      updateStats();
      saveStats();
    }

    function startTimer(){
      running = true;
      alarmPlayed = false;
      startTimestamp = Date.now();
      timerEl.textContent = "00:00:00";
      timerEl.classList.remove("red");
      tick();
      typeStat.style.textDecoration = "none"; // lock toggle
    }

    function tick(){
      if(!running) return;
      const elapsed = Math.floor((Date.now() - startTimestamp) / 1000);
      timerEl.textContent = formatHMS(elapsed);

      if(elapsed >= TYPE_SETTINGS[selectedType]){
        timerEl.classList.add("red");
        if(!alarmPlayed){
          alarmPlayed = true;
          alarmSound.currentTime = 0;
          alarmSound.play().catch(()=>{});
        }
      } else {
        timerEl.classList.remove("red");
      }

      const nextTick = 1000 - ((Date.now() - startTimestamp) % 1000);
      timerInterval = setTimeout(tick, nextTick);
    }

    function stopTimer(){
      clearTimeout(timerInterval);
      running = false;
      typeStat.style.textDecoration = "underline"; // unlock toggle
    }

    // UI wiring
    bladeInput.addEventListener("input",()=>{
      startBtn.disabled=!/^\d{4}$/.test(bladeInput.value);
    });
    startBtn.addEventListener("click",()=>{
      paleStat.textContent="Pale : "+bladeInput.value;
      bladeInput.value="";
      startTimer();
      document.getElementById("bladeContainer").style.display="none";
      stopBtn.style.display="inline-block";
    });
    stopBtn.addEventListener("click",()=>{
      if(Date.now()<lockoutUntil){alert("Locked out");return;}
      popupOverlay.style.display="flex";
      passwordInput.value=""; confirmPassword.disabled=true; popupMsg.textContent="";
    });
    passwordInput.addEventListener("input",()=>{
      confirmPassword.disabled=passwordInput.value.trim().length===0;
    });
    confirmPassword.addEventListener("click",()=>{
      if(passwordInput.value===PASSWORD){
        stopTimer();
        const elapsed = Math.floor((Date.now()-startTimestamp)/1000);
        stats[selectedType].runs.push(elapsed);
        stats[selectedType].count++;
        updateStats();
        saveStats();

        timerEl.textContent="00:00:00";
        timerEl.classList.remove("red");
        paleStat.textContent="Pale :";
        document.getElementById("bladeContainer").style.display="flex";
        startBtn.disabled=true;
        stopBtn.style.display="none";
        popupOverlay.style.display="none";
        failCount=0;
      } else {
        failCount++; passwordInput.value=""; confirmPassword.disabled=true;
        if(failCount>=3){
          popupMsg.textContent=`Trop d'essais. VerrouillÃ© 1min.`;
          lockoutUntil=Date.now()+LOCKOUT_SECONDS*1000;
          setTimeout(()=>{popupOverlay.style.display="none";},2500);
          stopBtn.disabled=true;
          setTimeout(()=>{stopBtn.disabled=false;failCount=0;},LOCKOUT_SECONDS*1000);
        } else {
          popupMsg.textContent=`Incorrect. Essais restants: ${3-failCount}`;
        }
      }
    });
    cancelPassword.addEventListener("click",()=>{popupOverlay.style.display="none";});

    typeStat.addEventListener("click",()=>{
      if(running) return; // block toggle while running
      setType(selectedType==="47.3" ? "62.2" : "47.3");
    });

    // init
    setType(selectedType);
  </script>
</body>
</html>
