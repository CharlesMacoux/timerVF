<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>CycleTime</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>

    /* ---------- FONTS ---------- */
    @font-face { font-family: 'SonsCondensed'; src: url('fonts/SonsCondensed-Semibold2.ttf') format('truetype'); font-weight: 600; }
    @font-face { font-family: 'SonsCondensedExtra'; src: url('fonts/SonsCondensed-Extrabold4.ttf') format('truetype'); font-weight: 800; }
    @font-face { font-family: 'Inter'; src: url('fonts/Inter-Regular.otf') format('opentype'); font-weight: 400; }

    :root{
      --green: #c8ff08;
      --teal:  #005E60;
      --btn-bckgrnd: #dee3ca;
      --teal-dark: #013d3d;
    }

    html,body{height:100%; margin:0;}
    body{
      background:var(--teal);
      color:white;
      font-family: 'SonsCondensed', Arial, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    #banner{
      width:100%;
      height:15vh;
      max-height:180px;
      object-fit:contain;
      background:var(--teal);
      display:block;
    }

    /* Pale + Moule + Type top-left */
    #paleStat, #mouleStat, #typeStat {
      position: absolute;
      left: 20px;
      font-size: 6vh;
      font-family: 'SonsCondensed', sans-serif;
    }
    #paleStat { top: 40px; display:flex; align-items:center; gap:0.6ch; }
    #mouleStat { top: 100px; }
    #typeStat { top: 160px; text-decoration:none; cursor:default; }

    /* small inline pale input placed inside #paleStat */
    #paleInlineInput {
      display: none;
      margin-left: 0.1ch;
      font-family: 'SonsCondensed', sans-serif;
      font-size: 6vh;
      font-weight: 600;
      color: white;
      background: transparent;
      border: none;
      outline: none;
      cursor: not-allowed;
      pointer-events: none;
    }

    #paleInlineInput::placeholder { color: rgba(255,255,255,0.35); }

    /* Stats top-right */
    #stats {
      position: absolute;
      top: 40px;
      right: 20px;
      font-size: 6vh;
      font-family: 'SonsCondensed', sans-serif;
      display: grid;
      gap: 6px 18px;
    }
    .stat { display:flex; justify-content:flex-end; gap:12px; }
    .label { min-width:10ch; text-align:right; font-weight:600; }
    .value { min-width:12ch; text-align:left; font-weight:600; }
    .target-time { color: var(--green); }

html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
}
    /* Timer + Step label */
 #main {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#stepLabel {
  font-family: 'SonsCondensed', sans-serif;
  font-weight: 600;
  font-size: 8vh;
  color: var(--green);
  text-align: center;
  width: 100%;
  margin-bottom: 2vh;
}
#timer {
  font-family: 'SonsCondensedExtra', 'Courier New', monospace;
  font-variant-numeric: tabular-nums;
  font-size: 59vh;
  //min-width: 7ch;
  text-align: center;
  line-height: 1;
  margin: 0 auto 2vh auto;
  color: var(--green);
  transition: color .2s ease;
}

    #timer.red {
      color:red;
      -webkit-text-stroke: 4px var(--teal-dark);
      text-shadow:
        -1px -1px 0 var(--teal-dark),
         1px -1px 0 var(--teal-dark),
        -1px  1px 0 var(--teal-dark),
         1px  1px 0 var(--teal-dark);
    }

    /* Blade input + Start */
    #bladeContainer{ display:flex; gap:1vw; align-items:center; justify-content:center; margin-top:1vh; }
    #bladeInput {
      font-family:'Inter',sans-serif;
      font-size:2.3vh;
      height:4.7vh; min-height:40px;
      border-radius:0.1vh;
      border:none;
      padding:0 1.6vh;
      width:12ch;
      text-align:center;
      background:#fff;
      color:var(--teal);
    }

button.controlBtn {
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  height: 50px;
  padding: 8px 10px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: white;
  color: var(--teal);
  box-sizing: border-box;
  margin: 0;
  display: flex;
  align-items: center;
  line-height: 1;
}

    button.controlBtn[disabled]{ opacity:1; cursor:not-allowed; background:#888; color:#ddd; }
    button.controlBtn:hover:not([disabled]){ background:var(--green); color:#003; }
    #stopBtn{ display:none; margin-top:1.5vh; }

    /* Fullscreen button (square) */
    #fullscreenBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width:44px;
      height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0);
      border: none;
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
      z-index: 9999;
    }
    #fullscreenBtn:hover { background: rgba(255,255,255,0.12); }
    #fullscreenBtn img { width: 28px; height: 28px; display:block; }

    /* Settings button */
    #settingsBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      width:56px;
      height:56px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0);
      border: none;
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
      z-index: 9999;
    }
    #settingsBtn:hover { background: rgba(255,255,255,0.12); }
    #settingsBtn img { width: 40px; height: 40px; display:block; }

    /* Popup (password) */
    #popupOverlay{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.55); z-index:60; }
    #popup{
      background:#fff;
      padding:22px 28px;
      border-radius:12px;
      min-width:300px;
      text-align:center;
      font-family:'Inter',sans-serif;
      box-shadow:0 8px 30px rgba(0,0,0,0.35);
    }
    #popup h2{ margin:0 0 12px; font-size:1.2rem; color:#000; }
    #popup input{
      width:86%;
      padding:8px;
      text-align:center;
      font-size:1rem;
      border:1px solid #ccc;
      border-radius:6px;
    }
    #popup .buttons{ margin-top:12px; display:flex; justify-content:center; gap:12px; }
    #popup .buttons button{ font-family:'Inter',sans-serif; font-size:1rem; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; }
    #popup .msg{ margin-top:8px; color:#b00; min-height:1.1em; }

    /* Settings modal (Inter font) - now supports expanded advanced section */
    #settingsOverlay{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.55); z-index:70; }
    #settings {
      background:#fff; color:#000; padding:22px; border-radius:10px; min-width:360px; max-height:80vh; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,0.35);
      font-family:'Inter',sans-serif;
      transition: min-width .15s ease;
    }
    #settings.expanded { min-width:720px; }
    #settings h3{ margin-top:0; margin-bottom:8px; font-size:1.2rem; }
    .settings-row{ display:flex; gap:12px; align-items:center; margin:8px 0; }
    .settings-row label{ width:110px; font-weight:600; font-size:0.95rem; }
    .settings-row input[type="text"], .settings-row input[type="number"], #typeInput {
      padding:10px; border-radius:6px; border:1px solid #ccc; width:155px; font-size:1rem;
      font-family: 'Inter', sans-serif;
    }
    .time-parts { display:inline-flex; gap:6px; align-items:center; }

    .time-parts input {
      width:60px;
      text-align:center;
      padding:8px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:1rem;
      font-family: 'Inter', sans-serif;
      background:white;
      color:#003;
    }

    /* muted (grayed) look for current time when not edited */
    .muted {
      opacity: 0.45;
    }

    #settings .btns{ display:flex; gap:12px; justify-content:flex-end; margin-top:14px; }
    #settings .btns button{ padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-size:1rem; }

    /* Advanced area (inside settings) */
    #advancedSection { display:none; margin-top:12px; padding-top:8px; border-top:1px solid #eee; }
    .step-row { display:flex; gap:2px; align-items:center; margin-bottom:2px; }
    .step-row input[type="text"] { padding:8px; border-radius:6px; border:1px solid #ccc; width:240px; font-family:Inter; }
    .step-row .end-time { display:flex; gap:4px; align-items:center; }
    .step-row .end-time input { width:60px; padding:8px; border-radius:6px; border:1px solid #ccc; text-align:center; font-family:Inter; }
   .step-row .removeStepBtn {
  padding: 4px 8px;
  font-size: 0.95rem;
  height: 32px;
}

    @media (max-width:600px){
      #settings{ min-width:90%; }
      .settings-row label{ width:80px; }
      .time-parts input { width:44px; }
      #settings.expanded { min-width:90%; }
      .step-row { flex-direction:column; align-items:flex-start; }
      .step-row input[type="text"] { width:100%; }
    }

.drag-handle {
  user-select: none;
  padding: 2px 8px;
  color: #666;
  cursor: grab;
  font-size: 1.5em;
  margin-right: 8px;
  vertical-align: middle;
}
.step-row.dragging {
  opacity: 0.5;
}
.step-row.drag-over {
  outline: 2px dashed #c8ff08;
}
  </style>
</head>
<body>
  <img id="banner" src="images/gebanner3.jpg" alt="GE banner">
  <div id="paleStat">Pale : <input id="paleInlineInput" type="text" maxlength="8" inputmode="numeric" placeholder="1234" aria-label="Pale number"></div>
  <div id="mouleStat">Moule : 02</div>
  <div id="typeStat">Type : <span id="typeVal">47.3</span></div>

  <div id="stats">
    <div class="stat"><span class="label">Moyenne :</span><span class="value" id="averageVal">--:--:--</span></div>
    <div class="stat"><span class="label">Meilleur :</span><span class="value" id="bestVal">--:--:--</span></div>
    <div class="stat"><span class="label">Objectif :</span><span class="value target-time" id="targetVal">24:00:00</span></div>
  </div>

  <div id="main">
    <div id="stepLabel"></div>
    <div id="timer">00:00:00</div>

    <div id="bladeContainer">
      <input id="bladeInput" type="text" maxlength="4" placeholder="Entrer # Pale Ici" inputmode="numeric" pattern="\d*">
      <button id="startBtn" class="controlBtn" disabled>Commencer</button>
    </div>

    <button id="stopBtn" class="controlBtn">Arrêter</button>

    <button id="fullscreenBtn" title="Plein écran">
      <img src="images/fullscreen.png" alt="Fullscreen" id="fullscreenIcon">
    </button>

    <button id="settingsBtn" title="Paramètres" class="controlBtn">
      <img src="images/settings.png" alt="Settings" style="width:40px;height:40px">
    </button>

  </div>

  <!-- password popup -->
  <div id="popupOverlay">
    <div id="popup" role="dialog" aria-modal="true">
      <h2>Veuillez entrer le mot de passe</h2>
      <input id="passwordInput" type="password" autocomplete="off" inputmode="text" />
      <div class="buttons">
        <button id="cancelPassword" class="controlBtn">Annuler</button>
        <button id="confirmPassword" class="controlBtn" disabled>Confirmer</button>
      </div>
      <div class="msg" id="popupMsg"></div>
    </div>
  </div>

  <!-- settings overlay -->
  <div id="settingsOverlay">
    <div id="settings" role="dialog" aria-modal="true">
      <h3>Paramètres</h3>

      <div class="settings-row" id="paleRow" style="display:none;">
        <label for="paleInput">Pale No</label>
        <input id="paleInput" type="text" maxlength="4" inputmode="numeric" placeholder="1234">
      </div>

      <div class="settings-row">
        <label for="typeInput">Type</label>
        <input id="typeInput" type="text" maxlength="16" placeholder="ex: 47.3">
      </div>

      <div class="settings-row">
        <label for="mouleInput">Moule</label>
        <input id="mouleInput" type="text" maxlength="8" inputmode="text" placeholder="02">
      </div>

      <div class="settings-row">
        <label>Objectif</label>
        <div class="time-parts">
          <input id="targetHours" maxlength="3" inputmode="numeric" placeholder="24" title="Heures">
          <span>:</span>
          <input id="targetMinutes" maxlength="2" inputmode="numeric" placeholder="00" title="Minutes">
          <span>:</span>
          <input id="targetSeconds" maxlength="2" inputmode="numeric" placeholder="00" title="Secondes">
        </div>
      </div>

      <div class="settings-row">
        <label>Temps actuel</label>
        <div class="time-parts">
          <input id="currentHours" maxlength="3" inputmode="numeric" title="Heures">
          <span>:</span>
          <input id="currentMinutes" maxlength="2" inputmode="numeric" title="Minutes">
          <span>:</span>
          <input id="currentSeconds" maxlength="2" inputmode="numeric" title="Secondes">
        </div>
      </div>

      <div class="settings-row">
        <label></label>
        <div style="display:flex; gap:8px;">
          <button id="toggleAdvancedBtn" class="controlBtn">Paramètres avancés</button>
        </div>
      </div>

      <!-- Advanced editing area (expanded inside settings) -->
      <div id="advancedSection" aria-hidden="true">
        <div style="font-weight:600;margin-bottom:8px;">Édition des étapes et objectifs de temps</div>
        <div id="stepsEditor"></div>
        <div style="margin-top:8px; display:flex; gap:8px;font-size:0.60rem;">
          <button id="addStep" class="controlBtn">+ Ajouter</button>
          <button id="sortStepEnds" class="controlBtn">Mettre en ordre</button>
        </div>
        <div style="margin-top:10px; color:#666; font-size:0.90rem;">
          Note : Le temps de fin de la dernière étape est toujours le temps de l'objectif.
        </div>
      </div>

      <div class="btns">
        <button id="closeSettings" class="controlBtn">Annuler</button>
        <button id="saveSettings" class="controlBtn" style="background:var(--green); color:#003">Sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- audio element; play once when triggered -->
  <audio id="alarmSound" src="music/mario.mp3" preload="auto"></audio>

  <script>
/* ====== CONFIG & STORAGE KEYS ====== */
const PASSWORD = "4321";
const LOCKOUT_SECONDS = 60;
const STORAGE_KEY_CONFIG = 'ct_config_v2';
const STORAGE_KEY_STATS = 'ct_stats_v2';

/* ====== Defaults ====== */
const DEFAULT_CONFIG = {
  type: "47.3",
  moule: "02",
  pale: "",
  targetSec: 24 * 3600,
  // step model: { label, endSec } ; start is always 0
  steps: [
    { label: 'Step 1', endSec: 2 * 3600 },     // 02:00:00
    { label: 'Step 2', endSec: 5.5 * 3600 }
  ]
};

/* ====== STATE ====== */
let config = loadConfigFromStorage();
let stats = loadStatsFromStorage();
let running = false;
let startTimestamp = null;
let tickTimeoutId = null;
let alarmPlayed = false;
let failCount = 0;
let lockoutUntil = 0;
let unlockContext = null;
let displayedPresetSec = null;

/* ====== ELEMENTS ====== */
const timerEl = document.getElementById('timer');
const stepLabelEl = document.getElementById('stepLabel');
const typeValEl = document.getElementById('typeVal');
const mouleStatEl = document.getElementById('mouleStat');
const targetValEl = document.getElementById('targetVal');
const averageVal = document.getElementById('averageVal');
const bestVal = document.getElementById('bestVal');
const paleStat = document.getElementById('paleStat');
const paleInlineInput = document.getElementById('paleInlineInput');
const bladeInput = document.getElementById('bladeInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const popupOverlay = document.getElementById('popupOverlay');
const passwordInput = document.getElementById('passwordInput');
const confirmPassword = document.getElementById('confirmPassword');
const cancelPassword = document.getElementById('cancelPassword');
const popupMsg = document.getElementById('popupMsg');
const alarmSound = document.getElementById('alarmSound');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const fullscreenIcon = document.getElementById('fullscreenIcon');
const settingsBtn = document.getElementById('settingsBtn');
const settingsOverlay = document.getElementById('settingsOverlay');
const settingsModal = document.getElementById('settings');
const typeInput = document.getElementById('typeInput');
const paleInput = document.getElementById('paleInput');
const mouleInput = document.getElementById('mouleInput');
const targetHours = document.getElementById('targetHours');
const targetMinutes = document.getElementById('targetMinutes');
const targetSeconds = document.getElementById('targetSeconds');
const saveSettings = document.getElementById('saveSettings');
const closeSettings = document.getElementById('closeSettings');
const currentHours = document.getElementById('currentHours');
const currentMinutes = document.getElementById('currentMinutes');
const currentSeconds = document.getElementById('currentSeconds');
const toggleAdvancedBtn = document.getElementById('toggleAdvancedBtn');
const advancedSection = document.getElementById('advancedSection');
const stepsEditor = document.getElementById('stepsEditor');
const addStep = document.getElementById('addStep');
const sortStepEnds = document.getElementById('sortStepEnds');

/* ====== STORAGE helpers ====== */
function loadConfigFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY_CONFIG);
    if (!raw) {
      localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(DEFAULT_CONFIG));
      return JSON.parse(JSON.stringify(DEFAULT_CONFIG));
    }
    const parsed = JSON.parse(raw);
    parsed.type = parsed.type || DEFAULT_CONFIG.type;
    parsed.moule = parsed.moule || DEFAULT_CONFIG.moule;
    parsed.pale = parsed.pale || DEFAULT_CONFIG.pale;
    parsed.targetSec = (typeof parsed.targetSec === 'number') ? parsed.targetSec : DEFAULT_CONFIG.targetSec;
    parsed.steps = Array.isArray(parsed.steps) ? parsed.steps : DEFAULT_CONFIG.steps.slice();
    return parsed;
  } catch (err) {
    localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(DEFAULT_CONFIG));
    return JSON.parse(JSON.stringify(DEFAULT_CONFIG));
  }
}
function saveConfigToStorage(){
  localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(config));
}
function loadStatsFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY_STATS);
    if (!raw){
      const base = {};
      localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(base));
      return base;
    }
    return JSON.parse(raw);
  } catch {
    const base = {};
    localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(base));
    return base;
  }
}
function saveStatsToStorage(){
  localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(stats));
}

/* ====== Time parsing/formatting ====== */
function parseHMSParts(h,m,s){
  const hh = parseInt(String(h||'0').replace(/\D/g,'')||'0',10) || 0;
  const mm = parseInt(String(m||'0').replace(/\D/g,'')||'0',10) || 0;
  const ss = parseInt(String(s||'0').replace(/\D/g,'')||'0',10) || 0;
  const minutes = Math.max(0, Math.min(59, mm));
  const seconds = Math.max(0, Math.min(59, ss));
  const hours = Math.max(0, hh);
  return hours * 3600 + minutes * 60 + seconds;
}
function secondsToHMS(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return { h, m, s };
}
function formatHMS(s){
  s = Math.max(0, Math.floor(s||0));
  const h = String(Math.floor(s/3600)).padStart(2,'0');
  const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const sec = String(s%60).padStart(2,'0');
  return `${h}:${m}:${sec}`;
}

/* ====== UI helpers ====== */
function ensureStatsEntryFor(type){
  if (!stats[type]) stats[type] = { runs: [], count: 0 };
}
function updateStatsUI(){
  const t = config.type;
  ensureStatsEntryFor(t);
  const runs = stats[t].runs || [];
  if (runs.length === 0){
    averageVal.textContent = '--:--:--';
    bestVal.textContent = '--:--:--';
  } else {
    const lastFive = runs.slice(-5);
    const avg = Math.floor(lastFive.reduce((a,b)=>a+b,0) / lastFive.length);
    const best = Math.min(...runs);
    averageVal.textContent = formatHMS(avg);
    bestVal.textContent = formatHMS(best);
  }
  targetValEl.textContent = formatHMS(config.targetSec || 0);
  typeValEl.textContent = config.type;
  mouleStatEl.textContent = 'Moule : ' + (config.moule || '');
  if (paleInlineInput.style.display !== 'none') {
    paleInlineInput.value = config.pale || '';
  } else {
    paleStat.title = config.pale || '';
  }
}

/* ====== Steps logic (end-based) ====== */
function getCurrentStepForElapsed(elapsedSec){
  if (!Array.isArray(config.steps) || config.steps.length === 0) return null;
  const steps = config.steps.slice().sort((a,b) => a.endSec - b.endSec);
  for (let i=0;i<steps.length;i++){
    if (elapsedSec < steps[i].endSec) return steps[i];
  }
  return steps[steps.length-1];
}
function renderStepLabel(elapsedSec){
  const s = getCurrentStepForElapsed(elapsedSec);
  if (s) {
    stepLabelEl.textContent = s.label || '';
  } else {
    stepLabelEl.textContent = '';
  }
}

/* ====== Timer core (precise tick) ====== */
function startTimerWithPreset(elapsedSec){
  running = true;
  alarmPlayed = false;
  startTimestamp = Date.now() - (Math.max(0, Math.floor(elapsedSec)) * 1000);
  scheduleTick();
  showPaleInline(true);
  displayedPresetSec = null;
}
function startTimer(){
  startTimerWithPreset(0);
  timerEl.textContent = '00:00:00';
  timerEl.classList.remove('red');
}
function scheduleTick(){
  if (!running) return;
  tick();
  const msSinceStart = Date.now() - startTimestamp;
  const nextTick = 1000 - (msSinceStart % 1000) || 1000;
  tickTimeoutId = setTimeout(scheduleTick, nextTick);
}
function tick(){
  if (!running) return;
  const elapsed = Math.floor((Date.now() - startTimestamp) / 1000);
  timerEl.textContent = formatHMS(elapsed);
  renderStepLabel(elapsed);
  if (elapsed >= (config.targetSec || 0)){
    timerEl.classList.add('red');
    if (!alarmPlayed){
      alarmPlayed = true;
      try {
        alarmSound.currentTime = 0;
        alarmSound.play().catch(()=>{});
      } catch(e){}
    }
  } else {
    timerEl.classList.remove('red');
  }
}
function stopTimerInternal(){
  if (tickTimeoutId){ clearTimeout(tickTimeoutId); tickTimeoutId = null; }
  running = false;
  alarmPlayed = false;
  try { alarmSound.pause(); alarmSound.currentTime = 0; } catch(e){}
  showPaleInline(false);
  timerEl.textContent = '00:00:00';
  timerEl.classList.remove('red');
  stepLabelEl.textContent = '';
  displayedPresetSec = null;
  startTimestamp = null;
}

/* ====== Inline pale input show/hide ====== */
function showPaleInline(on) {
  if (on) {
    paleInlineInput.style.display = 'inline-block';
    paleInlineInput.value = config.pale || '';
  } else {
    paleInlineInput.style.display = 'none';
  }
}

/* ====== Input restrictions ====== */
function onlyDigitsListener(el, maxLen){
  if (!el) return;
  el.addEventListener('input', ()=> {
    const cleaned = String(el.value || '').replace(/\D/g, '');
    el.value = (maxLen ? cleaned.slice(0,maxLen) : cleaned);
  });
  el.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
    if (!allowed.includes(e.key) && !/^\d$/.test(e.key)) {
      e.preventDefault();
    }
  });
}
function digitsDotListener(el, maxLen){
  if (!el) return;
  el.addEventListener('input', ()=> {
    let cleaned = String(el.value || '').replace(/[^0-9.]/g, "");
    const parts = cleaned.split(".");
    if (parts.length > 2){
      cleaned = parts[0] + "." + parts.slice(1).join("");
    }
    el.value = (maxLen ? cleaned.slice(0,maxLen) : cleaned);
  });
  el.addEventListener('keydown', (e) => {
    const allowed = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End','.'];
    if (!allowed.includes(e.key) && !/^[0-9]$/.test(e.key)) {
      e.preventDefault();
    }
    if (e.key === "." && el.value.includes(".")) e.preventDefault();
  });
}

// Apply restrictions:
onlyDigitsListener(bladeInput, 4);       // start input
onlyDigitsListener(paleInput, 8);        // settings pale
onlyDigitsListener(paleInlineInput, 8);  // inline pale while running
digitsDotListener(typeInput, 16);        // type (e.g. 47.3)
digitsDotListener(mouleInput, 8);        // moule (accept periods)
onlyDigitsListener(targetHours, 3);
onlyDigitsListener(targetMinutes, 2);
onlyDigitsListener(targetSeconds, 2);
onlyDigitsListener(currentHours, 3);
onlyDigitsListener(currentMinutes, 2);
onlyDigitsListener(currentSeconds, 2);

/* ====== Start / Stop wiring ====== */
bladeInput.addEventListener('input', () => {
  startBtn.disabled = bladeInput.value.replace(/\D/g,'').length !== 4;
});
closeSettings.addEventListener('click', function() {
  advancedSection.style.display = 'none';
  advancedSection.setAttribute('aria-hidden', 'true');
  settingsModal.classList.remove('expanded');
  settingsOverlay.style.display = 'none';
});
startBtn.addEventListener('click', ()=> {
  if (bladeInput.value && bladeInput.value.length > 0){
    config.pale = bladeInput.value.replace(/\D/g,'');
    saveConfigToStorage();
  }
  paleInlineInput.value = config.pale || '';
  bladeInput.value = '';
  startBtn.disabled = true;
  document.getElementById('bladeContainer').style.display = 'none';
  stopBtn.style.display = 'inline-block';
  document.getElementById('paleRow').style.display = 'flex';

  let elapsed = 0;
  if (displayedPresetSec !== null) {
    elapsed = displayedPresetSec;
  } else {
    const parts = (timerEl.textContent || '00:00:00').split(':').map(p => parseInt(p||'0',10) || 0);
    if (parts.length === 3) elapsed = parts[0]*3600 + parts[1]*60 + parts[2];
  }
  startTimerWithPreset(elapsed);
  updateStatsUI();
});
stopBtn.addEventListener('click', ()=> {
  if (Date.now() < lockoutUntil){
    const remaining = Math.ceil((lockoutUntil - Date.now())/1000);
    alert(`Verrouillé. Attendez ${remaining}s.`);
    return;
  }
  unlockContext = "stop";
  popupOverlay.style.display = 'flex';
  passwordInput.value = '';
  confirmPassword.disabled = true;
  popupMsg.textContent = '';
  passwordInput.focus();
});

/* ====== Password popup logic (shared for Stop & Settings) ====== */
passwordInput.addEventListener('input', ()=> {
  confirmPassword.disabled = passwordInput.value.trim().length === 0;
});
cancelPassword.addEventListener('click', ()=> {
  popupOverlay.style.display = 'none';
  passwordInput.value = '';
  confirmPassword.disabled = true;
  unlockContext = null;
});
confirmPassword.addEventListener('click', ()=> {
  if (passwordInput.value === PASSWORD){
    popupOverlay.style.display = 'none';
    failCount = 0;
    if (unlockContext === "stop") {
      const elapsed = running && startTimestamp ? Math.floor((Date.now() - startTimestamp)/1000) : 0;
      stopTimerInternal();
      if (elapsed > 0){
        const t = config.type;
        ensureStatsEntryFor(t);
        stats[t].runs.push(elapsed);
        stats[t].count = (stats[t].count || 0) + 1;
        saveStatsToStorage();
      }
      updateStatsUI();
      paleStat.setAttribute('data-value', '');
      document.getElementById('bladeContainer').style.display = 'flex';
      startBtn.disabled = true;
      stopBtn.style.display = 'none';
      document.getElementById('paleRow').style.display = 'none';
    } else if (unlockContext === "settings") {
      openSettingsModal();
    }
    unlockContext = null;
  } else {
    failCount++;
    passwordInput.value = '';
    confirmPassword.disabled = true;
    if (failCount >= 3){
      popupMsg.textContent = `Trop d'essais. Verrouillé ${LOCKOUT_SECONDS}s.`;
      lockoutUntil = Date.now() + LOCKOUT_SECONDS * 1000;
      setTimeout(()=>{ popupOverlay.style.display = 'none'; }, 2500);
      setTimeout(()=>{ failCount = 0; }, LOCKOUT_SECONDS * 1000);
    } else {
      popupMsg.textContent = `Incorrect. Essais restants: ${3 - failCount}`;
    }
  }
});

/* ====== Settings button (requires password) ====== */
settingsBtn.addEventListener('click', () => {
  if (settingsOverlay.style.display === 'flex') {
    settingsOverlay.style.display = 'none';
    return;
  }
  if (Date.now() < lockoutUntil){
    const remaining = Math.ceil((lockoutUntil - Date.now())/1000);
    alert(`Verrouillé. Attendez ${remaining}s.`);
    return;
  }
  unlockContext = "settings";
  popupOverlay.style.display = 'flex';
  passwordInput.value = '';
  confirmPassword.disabled = true;
  popupMsg.textContent = '';
  passwordInput.focus();
});
function openSettingsModal(){
  populateSettingsFields();
  settingsOverlay.style.display = 'flex';
  settingsModal.classList.remove('expanded');
  advancedSection.style.display = 'none';
  advancedSection.setAttribute('aria-hidden','true');
  setCurrentTimeInputsToMuted();
  setTimeout(()=>document.activeElement.blur(), 0);
}
function populateSettingsFields(){
  typeInput.value = config.type || '';
  paleInput.value = config.pale || '';
  mouleInput.value = config.moule || '';
  const parts = secondsToHMS(config.targetSec || 0);
  targetHours.value = parts.h.toString();
  targetMinutes.value = String(parts.m).padStart(2,'0');
  targetSeconds.value = String(parts.s).padStart(2,'0');
  currentHours.value = '00';
  currentMinutes.value = '00';
  currentSeconds.value = '00';
  currentHours.dataset.modified = '0';
  currentMinutes.dataset.modified = '0';
  currentSeconds.dataset.modified = '0';
  document.getElementById('paleRow').style.display = running ? 'flex' : 'none';
}
function setCurrentTimeInputsToMuted() {
  currentHours.classList.add('muted');
  currentMinutes.classList.add('muted');
  currentSeconds.classList.add('muted');
  currentHours.value = '00';
  currentMinutes.value = '00';
  currentSeconds.value = '00';
}
function unmuteInput(el) {
  el.classList.remove('muted');
}
[currentHours, currentMinutes, currentSeconds].forEach((el) => {
  el.addEventListener('focus', () => {
    if (el.dataset.modified !== '1') {
      el.dataset.modified = '1';
      if (!el.value) el.value = '0';
      unmuteInput(el);
    }
  });
  el.addEventListener('input', () => {
    el.dataset.modified = '1';
    unmuteInput(el);
  });
  el.addEventListener('click', () => {
    if (el.dataset.modified !== '1') {
      el.dataset.modified = '1';
      unmuteInput(el);
    }
  });
});
settingsOverlay.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (settingsOverlay.style.display !== 'flex') return;
    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
      e.preventDefault();
      saveSettings.click();
    }
  }
});
popupOverlay.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (popupOverlay.style.display !== 'flex') return;
    const active = document.activeElement;
    if (active && active.tagName === 'INPUT') {
      e.preventDefault();
      confirmPassword.click();
    }
  }
});
let settingsMouseDownTarget = null;
settingsOverlay.addEventListener('mousedown', (ev) => {
  settingsMouseDownTarget = ev.target;
});
settingsOverlay.addEventListener('click', (ev) => {
  if (ev.target === settingsOverlay && settingsMouseDownTarget === settingsOverlay) {
    settingsOverlay.style.display = 'none';
  }
  settingsMouseDownTarget = null;
});

/* ====== ADVANCED SECTION: Step Editor ====== */

toggleAdvancedBtn.addEventListener('click', ()=> {
  const open = advancedSection.style.display === 'block';
  if (open) {
    advancedSection.style.display = 'none';
    advancedSection.setAttribute('aria-hidden','true');
    settingsModal.classList.remove('expanded');
  } else {
    advancedSection.style.display = 'block';
    advancedSection.setAttribute('aria-hidden','false');
    settingsModal.classList.add('expanded');
    renderStepsEditor();
  }
});

function renderStepsEditor() {
  stepsEditor.innerHTML = '';
  // Always render Start row first (permanent)
  stepsEditor.appendChild(createSettingsStepRow(
    { label: 'Début', endSec: 0 }, -1, true
  ));
  // Render each actual step (all editable, including last)
  config.steps = Array.isArray(config.steps) ? config.steps.slice().sort((a,b)=>a.endSec-b.endSec) : [];
  config.steps.forEach((step, idx) => {
    stepsEditor.appendChild(createSettingsStepRow(step, idx, false));
  });
  if (config.steps.length === 0) {
    stepsEditor.appendChild(createSettingsStepRow(
      { label:'Step 1', endSec: config.targetSec }, 0, false
    ));
  }
}

function createSettingsStepRow(step, index, isStart) {
  const row = document.createElement('div');
  row.className = 'step-row';

  // Leftmost slot: drag handle or empty placeholder for alignment
  let leftSlot;
  if (!isStart) {
    leftSlot = document.createElement('span');
    leftSlot.textContent = '≡';
    leftSlot.className = 'drag-handle';
    leftSlot.draggable = true;

    // Drag events only on dragHandle
    leftSlot.addEventListener('dragstart', function(e) {
      e.dataTransfer.effectAllowed = 'move';
      row.classList.add('dragging');
      const allRows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
      const dragIdx = allRows.indexOf(row);
      e.dataTransfer.setData('text/plain', dragIdx);
    });
    leftSlot.addEventListener('dragend', function(e) {
      row.classList.remove('dragging');
    });

    // Drop logic on row
    row.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      row.classList.add('drag-over');
    });
    row.addEventListener('dragleave', function(e) {
      row.classList.remove('drag-over');
    });
    row.addEventListener('drop', function(e) {
      e.preventDefault();
      row.classList.remove('drag-over');
      const draggedIdx = parseInt(e.dataTransfer.getData('text/plain'),10);
      const allRows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
      const targetIdx = allRows.indexOf(row);
      if (draggedIdx === targetIdx) return;
      const draggedRow = allRows[draggedIdx];
      if (draggedRow && row !== draggedRow) {
        if (targetIdx > draggedIdx) {
          stepsEditor.insertBefore(draggedRow, row.nextSibling);
        } else {
          stepsEditor.insertBefore(draggedRow, row);
        }
        renumberStepRows();
      }
    });
  } else {
    leftSlot = document.createElement('span');
    // Match drag-handle's width for alignment
    leftSlot.className = 'drag-placeholder';
    leftSlot.style.display = 'inline-block';
    leftSlot.style.width = '2.35em'; // Match .drag-handle's width (padding + font-size + margin)
  }
  row.appendChild(leftSlot);

  // Label input
  const labelInput = document.createElement('input');
  labelInput.type = 'text';
  labelInput.value = step.label || (isStart ? 'Début' : `Step ${index+1}`);
  labelInput.placeholder = 'Label';
  labelInput.style.fontFamily = 'Inter';
  if (isStart) {
    labelInput.disabled = true;
    labelInput.style.fontWeight = '600';
  }
  row.appendChild(labelInput);

  // Time inputs
  const endWrap = document.createElement('div');
  endWrap.className = 'end-time';
  const endH = document.createElement('input');
  endH.className = 'endH'; endH.placeholder = 'hh';
  const endM = document.createElement('input');
  endM.className = 'endM'; endM.placeholder = 'mm';
  const endS = document.createElement('input');
  endS.className = 'endS'; endS.placeholder = 'ss';
  let parts;
  if (isStart) {
    parts = { h: 0, m: 0, s: 0 };
  } else {
    parts = secondsToHMS(step.endSec || 0);
  }
  endH.value = parts.h;
  endM.value = String(parts.m).padStart(2,'0');
  endS.value = String(parts.s).padStart(2,'0');
  if (isStart) {
    endH.disabled = true; endM.disabled = true; endS.disabled = true;
  } else {
    onlyDigitsListener(endH, 3);
    onlyDigitsListener(endM, 2);
    onlyDigitsListener(endS, 2);
  }
  endWrap.appendChild(endH);
  endWrap.appendChild(document.createTextNode(':'));
  endWrap.appendChild(endM);
  endWrap.appendChild(document.createTextNode(':'));
  endWrap.appendChild(endS);
  row.appendChild(endWrap);

  // Remove button
  let removeBtn = null;
  if (isStart) {
    removeBtn = document.createElement('span');
    removeBtn.style.display = 'inline-block';
    removeBtn.style.width = '70px';
  } else {
    removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'removeStepBtn controlBtn';
    removeBtn.textContent = 'Retirer';
    removeBtn.addEventListener('click', () => {
      row.remove();
      const rows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
      if (rows.length === 0) {
        stepsEditor.appendChild(createSettingsStepRow({label:'Step 1', endSec: config.targetSec}, 0, false));
      }
    });
  }
  row.appendChild(removeBtn);
  return row;
}
function renumberStepRows() {
  const allRows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
  allRows.forEach((r, i) => {
    const labelInput = r.querySelector('input[type="text"]');
    if (labelInput) {
      if (/^Step \d+$/.test(labelInput.value)) {
        labelInput.value = `Step ${i+1}`;
      }
    }
  });
}
function collectStepsFromEditor(){
  const rows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
  const newSteps = [];
  for (let i=0;i<rows.length;i++){
    const r = rows[i];
    const label = (r.querySelector('input[type="text"]').value || '').trim() || `Step ${i+1}`;
    const endH = parseInt((r.querySelector('.endH').value||'0'),10) || 0;
    const endM = parseInt((r.querySelector('.endM').value||'0'),10) || 0;
    const endS = parseInt((r.querySelector('.endS').value||'0'),10) || 0;
    const endSec = Math.max(0, endH*3600 + Math.min(59,endM)*60 + Math.min(59,endS));
    newSteps.push({ label, endSec });
  }
  for (let i=1;i<newSteps.length;i++){
    if (newSteps[i].endSec <= newSteps[i-1].endSec) {
      alert(`Invalid steps: step ${i+1} end must be greater than previous step end.`);
      return null;
    }
  }
  if (newSteps.length === 0) {
    newSteps.push({ label:'Step 1', endSec: config.targetSec });
  }
  return newSteps;
}

saveSettings.addEventListener('click', () => {
  // 1. Save simple fields
  const newType  = (typeInput.value || '').trim() || '47.3';
  const newPale  = (paleInput.value || '').trim().replace(/\D/g,'');
  const newMoule = (mouleInput.value || '').trim();
  const newTargetSec = parseHMSParts(targetHours.value, targetMinutes.value, targetSeconds.value);

  config.type = newType;
  config.pale = newPale;
  config.moule = newMoule;
  config.targetSec = newTargetSec;

  // 2. Save advanced steps if the stepsEditor exists (expanded advanced section)
  if (typeof stepsEditor !== "undefined" && stepsEditor && stepsEditor.childNodes.length > 0) {
    // Collect steps from editor (skip the first row, which is "Début")
    const rows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
    let steps = [];
    let prevEnd = -1;
    let badStep = false;
    rows.forEach((row, i) => {
      const labelInput = row.querySelector('input[type="text"]');
      const endH = parseInt(row.querySelector('.endH').value || '0', 10) || 0;
      const endM = parseInt(row.querySelector('.endM').value || '0', 10) || 0;
      const endS = parseInt(row.querySelector('.endS').value || '0', 10) || 0;
      const endSec = Math.max(0, endH * 3600 + Math.min(59, endM)*60 + Math.min(59, endS));
      if (endSec <= prevEnd) {
        alert(`Invalid steps: step ${i+1} end must be greater than previous step end.`);
        badStep = true;
        return;
      }
      steps.push({
        label: (labelInput.value || '').trim() || `Step ${i+1}`,
        endSec: endSec
      });
      prevEnd = endSec;
    });
    if (badStep) return; // abort save if step times invalid
    if (steps.length === 0) {
      // fallback: single step to target
      steps = [{ label:'Step 1', endSec: config.targetSec }];
    }
    config.steps = steps;
  }

  // 3. Save config/stats to localStorage
  saveConfigToStorage();
  ensureStatsEntryFor(newType);
  saveStatsToStorage();

  // 4. Handle "Actual Time" menu
  // Only use if at least one current-time field was modified
  let useActualTime =
    currentHours.dataset.modified === '1' ||
    currentMinutes.dataset.modified === '1' ||
    currentSeconds.dataset.modified === '1';
  let h = useActualTime ? (parseInt(currentHours.value, 10) || 0) : 0;
  let m = useActualTime ? (parseInt(currentMinutes.value, 10) || 0) : 0;
  let s = useActualTime ? (parseInt(currentSeconds.value, 10) || 0) : 0;
  let newActualSec = h*3600 + m*60 + s;

  if (useActualTime && newActualSec >= 0) {
    if (running) {
      // Timer is running: update startTimestamp for new elapsed
      if (tickTimeoutId) clearTimeout(tickTimeoutId);
      running = true;
      alarmPlayed = false;
      startTimestamp = Date.now() - (newActualSec * 1000);
      scheduleTick();
    } else {
      // Not running: just update display
      timerEl.textContent = formatHMS(newActualSec);
      timerEl.classList.remove('red');
    }
  } else {
    if (!running) {
      timerEl.textContent = '00:00:00';
      timerEl.classList.remove('red');
    }
  }

  updateStatsUI();
  settingsOverlay.style.display = 'none';
});

addStep.addEventListener('click', ()=>{
  const rows = Array.from(stepsEditor.querySelectorAll('.step-row'));
  let prevEnd = 0;
  if (rows.length > 1) {
    const lastRow = rows[rows.length-1];
    const lastH = parseInt(lastRow.querySelector('.endH').value||'0',10)||0;
    const lastM = parseInt(lastRow.querySelector('.endM').value||'0',10)||0;
    const lastS = parseInt(lastRow.querySelector('.endS').value||'0',10)||0;
    prevEnd = lastH*3600 + lastM*60 + lastS;
  }
  let defaultEnd = Math.min(config.targetSec, prevEnd + 60);
  stepsEditor.appendChild(createSettingsStepRow({label:`Step ${rows.length}`, endSec: defaultEnd}, rows.length-1, false));
  renumberStepRows();
});
sortStepEnds.addEventListener('click', ()=>{
  const rows = Array.from(stepsEditor.querySelectorAll('.step-row')).slice(1);
  const list = rows.map(r => {
    const h = parseInt(r.querySelector('.endH').value||'0',10)||0;
    const m = parseInt(r.querySelector('.endM').value||'0',10)||0;
    const s = parseInt(r.querySelector('.endS').value||'0',10)||0;
    return { row: r, endSec: h*3600 + m*60 + s };
  });
  list.sort((a,b) => a.endSec - b.endSec);
  rows.forEach(r => r.remove());
  list.forEach(item => stepsEditor.appendChild(item.row));
  renumberStepRows();
});
[targetHours, targetMinutes, targetSeconds].forEach(inp => {
  inp.addEventListener('input', () => {});
});

/* ====== Inline pale editing while running ====== */
paleInlineInput.addEventListener('input', () => {
  const cleaned = paleInlineInput.value.replace(/\D/g, '');
  paleInlineInput.value = cleaned;
  config.pale = cleaned;
  saveConfigToStorage();
  paleStat.setAttribute('data-value', config.pale || '');
});

/* ====== Secret CLR reset (C + L + R) ====== */
const pressed = new Set();
function resetCurrentTypeStats(){
  const t = config.type;
  stats[t] = { runs: [], count: 0 };
  saveStatsToStorage();
  updateStatsUI();
  console.log('Stats reset for', t);
}
document.addEventListener('keydown', (e) => {
  const k = (e.key || '').toLowerCase();
  pressed.add(k);
  if (pressed.has('c') && pressed.has('l') && pressed.has('r')) {
    e.preventDefault();
    bladeInput.value = bladeInput.value.replace(/\D/g,'');
    resetCurrentTypeStats();
    pressed.clear();
  }
});
document.addEventListener('keyup', (e) => { pressed.delete((e.key||'').toLowerCase()); });

/* ====== Fullscreen support + F-key ====== */
fullscreenBtn.addEventListener('click', () => { toggleFullScreen(); });
document.addEventListener('keydown', (e) => {
  if (e.key.toLowerCase() === 'f') {
    if (settingsOverlay.style.display === 'flex') {
      return;
    }
    e.preventDefault();
    toggleFullScreen();
  }
});
function toggleFullScreen(){
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(()=>{});
  } else {
    document.exitFullscreen().catch(()=>{});
  }
}
document.addEventListener('fullscreenchange', () => {
  if (document.fullscreenElement) {
    fullscreenIcon.src = 'images/exitfullscreen.png';
    fullscreenIcon.alt = 'Quitter plein écran';
  } else {
    fullscreenIcon.src = 'images/fullscreen.png';
    fullscreenIcon.alt = 'Plein écran';
  }
});

/* ====== Initialization ====== */
function init(){
  config.type = config.type || DEFAULT_CONFIG.type;
  config.moule = config.moule || DEFAULT_CONFIG.moule;
  config.pale = config.pale || DEFAULT_CONFIG.pale;
  config.targetSec = (typeof config.targetSec === 'number') ? config.targetSec : DEFAULT_CONFIG.targetSec;
  config.steps = Array.isArray(config.steps) ? config.steps.slice().map(s => ({ label: s.label || 'Step', endSec: Math.max(0, Math.floor(s.endSec || 0)) })) : DEFAULT_CONFIG.steps.slice();
  if (config.steps.length === 0) config.steps = [{label:'Step 1', endSec: config.targetSec}];
  saveConfigToStorage();
  ensureStatsEntryFor(config.type);
  saveStatsToStorage();
  updateStatsUI();
  settingsOverlay.style.display = 'none';
  popupOverlay.style.display = 'none';
  advancedSection.style.display = 'none';
  showPaleInline(false);
  document.getElementById('paleRow').style.display = 'none';
  currentHours.value = '00';
  currentMinutes.value = '00';
  currentSeconds.value = '00';
  currentHours.dataset.modified = '0';
  currentMinutes.dataset.modified = '0';
  currentSeconds.dataset.modified = '0';
  setCurrentTimeInputsToMuted();
  displayedPresetSec = null;
  stepLabelEl.textContent = '';
}
init();
window.addEventListener('beforeunload', ()=> { if (tickTimeoutId) clearTimeout(tickTimeoutId); });
</script>
</body>
</html>
