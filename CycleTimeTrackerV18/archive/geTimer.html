<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Cycle Time</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- FONTS ---------- */
    @font-face {
      font-family: 'SonsCondensed';
      src: url('fonts/SonsCondensed-Semibold.ttf') format('truetype');
      font-weight: 600;
    }
    @font-face {
      font-family: 'SonsCondensedExtra';
      src: url('fonts/SonsCondensed-Extrabold.ttf') format('truetype');
      font-weight: 800;
    }
    @font-face {
      font-family: 'Inter';
      src: url('fonts/Inter-Regular.otf') format('opentype');
      font-weight: 400;
    }

    :root{
      --green: #c8ff08;
      --teal:  #005E60;
      --btn-hover: #a6d607;
      --teal-dark: #013d3d;
    }

    html,body{height:100%; margin:0;}
    body{
      background:var(--teal);
      color:white;
      font-family: 'SonsCondensed', Arial, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    #banner{
      width:100%;
      height:15vh;
      max-height:180px;
      object-fit:contain;
      background:var(--teal);
      display:block;
    }

    /* Pale + Moule + Type top-left */
    #paleStat, #mouleStat, #typeStat {
      position: absolute;
      left: 20px;
      font-size: 6vh;
      font-family: 'SonsCondensed', sans-serif;
    }
    #paleStat { top: 40px; }
    #mouleStat { top: 100px; }
    #typeStat { top: 160px; }

    /* Stats top-right */
    #stats {
      position: absolute;
      top: 40px;
      right: 20px;
      font-size: 6vh;
      font-family: 'SonsCondensed', sans-serif;
      display: grid;
      gap: 6px 18px;
    }
    .stat { display:flex; justify-content:flex-end; gap:12px; }
    .label { min-width:10ch; text-align:right; font-weight:600; }
    .value { min-width:12ch; text-align:left; font-weight:600; }
    .target-time { color: var(--green); }

    /* Timer */
    #main { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #timer {
      font-family: 'SonsCondensedExtra','Courier New',monospace;
      font-variant-numeric: tabular-nums;
      font-size: 50vh;
      min-width:7.05ch;
      text-align:left;
      line-height:1;
      margin:0 auto 2vh auto;
      color: var(--green);
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
      transition: color .2s ease;
    }
    #timer.red {
      color:red;
      -webkit-text-stroke: 4px var(--teal-dark);
      text-shadow:
        -1px -1px 0 var(--teal-dark),
         1px -1px 0 var(--teal-dark),
        -1px  1px 0 var(--teal-dark),
         1px  1px 0 var(--teal-dark);
    }

    /* Blade input + Start */
    #bladeContainer{ display:flex; gap:1vw; align-items:center; justify-content:center; margin-top:1vh; }
    #bladeInput {
      font-family:'Inter',sans-serif;
      font-size:2.3vh;
      height:5.5vh; min-height:40px;
      border-radius:0.1vh; 
      border:none;
      padding:0 1.6vh;
      width:12ch;
      text-align:center;
    }

    button.controlBtn {
      font-family:'Inter',sans-serif;
      font-size:2.3vh;
      height:6.5vh; min-height:40px;
      border-radius:1vh; 
      border:none;
      padding:0 1.6vh;
      background:white;
      color:var(--teal);
      cursor:pointer;
    }

    button.controlBtn[disabled]{ opacity:1; cursor:not-allowed; background:#888; }
    button.controlBtn:hover:not([disabled]){ background:var(--green); }
    #stopBtn{ display:none; margin-top:1.5vh; }

    /* Popup */
    #popupOverlay{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.55); }
    #popup{
      background:#fff;
      padding:30px 40px;
      border-radius:12px;
      min-width:320px;
      text-align:center;
      font-family:'Inter',sans-serif;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    #popup h2{ margin:0 0 18px; font-size:1.4rem; color:#000; }
    #popup input{
      width:80%;
      padding:10px;
      text-align:center;
      font-size:1rem;
      border:1px solid #ccc;
      border-radius:6px;
    }
    #popup .buttons{
      margin-top:16px;
      display:flex;
      justify-content:center;
      gap:14px;
    }
    #popup .buttons button{
      font-family:'Inter',sans-serif;
      font-size:1rem;
      padding:12px 24px;
      border:none;
      border-radius:8px;
      background:#eee;
      color:var(--teal);
      cursor:pointer;
      transition:background 0.2s;
    }
    #popup .buttons button:hover:not([disabled]){
      background:var(--green);
    }
    #popup .buttons button:disabled{
      background:#888;
      cursor:not-allowed;
    }
    #popup .msg{ margin-top:12px; min-height:1.2em; color:#b00; font-size:.95rem; }
  </style>
</head>
<body>
  <img id="banner" src="images/gebanner3.jpg" alt="GE banner">
  <div id="paleStat">Pale :</div>
  <div id="mouleStat">Moule : 02</div>
  <div id="typeStat">Type : 47.3</div>

  <div id="stats">
    <div class="stat"><span class="label">Moyenne :</span><span class="value" id="averageVal">--:--:--</span></div>
    <div class="stat"><span class="label">Meilleur :</span><span class="value" id="bestVal">--:--:--</span></div>
    <div class="stat"><span class="label">Objectif :</span><span class="value target-time" id="targetVal">24:00:00</span></div>
  </div>

  <div id="main">
    <div id="timer">00:00:00</div>
    <div id="bladeContainer">
      <input id="bladeInput" type="text" maxlength="4" placeholder="Entrer # Pale Ici">
      <button id="startBtn" class="controlBtn" disabled>Commencer</button>
    </div>
    <button id="stopBtn" class="controlBtn">Stop</button>
  </div>

  <div id="popupOverlay">
    <div id="popup">
      <h2>Veuillez entrer le mot de passe</h2>
      <input id="passwordInput" type="password">
      <div class="buttons">
        <button id="cancelPassword">Annuler</button>
        <button id="confirmPassword" disabled>Confirmer</button>
      </div>
      <div class="msg" id="popupMsg"></div>
    </div>
  </div>

<script>
  const TIME_LIMIT = 24; // seconds (use 24*3600 for 24h)
  const PASSWORD = "4321";
  const LOCKOUT_SECONDS = 60;

  let seconds = 0, timerInterval = null, runs = [];
  let failCount = 0, lockoutUntil = 0;
  let alarmPlayed = false;

  const timerEl = document.getElementById("timer");
  const paleStat = document.getElementById("paleStat");
  const averageVal = document.getElementById("averageVal");
  const bestVal = document.getElementById("bestVal");
  const bladeInput = document.getElementById("bladeInput");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const popupOverlay = document.getElementById("popupOverlay");
  const passwordInput = document.getElementById("passwordInput");
  const confirmPassword = document.getElementById("confirmPassword");
  const cancelPassword = document.getElementById("cancelPassword");
  const popupMsg = document.getElementById("popupMsg");

  const audio = new Audio("music/mario.mp3");

  // -------- LOCAL STORAGE LOAD --------
  let stored = JSON.parse(localStorage.getItem("cycleStats")) || {
    runs: [],
  };
  runs = stored.runs || [];
  updateStats();

  function formatTime(s) {
    let h = String(Math.floor(s / 3600)).padStart(2, '0');
    let m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
    let sec = String(s % 60).padStart(2, '0');
    return `${h}:${m}:${sec}`;
  }

  function updateStats() {
    if (!runs.length) {
      averageVal.textContent = "--:--:--";
      bestVal.textContent = "--:--:--";
      return;
    }
    let avg = Math.floor(runs.reduce((a, b) => a + b, 0) / runs.length);
    let best = Math.min(...runs);
    averageVal.textContent = formatTime(avg);
    bestVal.textContent = formatTime(best);

    // save to localStorage
    localStorage.setItem("cycleStats", JSON.stringify({ runs }));
  }

  function tick() {
    seconds++;
    timerEl.textContent = formatTime(seconds);
    if (seconds >= TIME_LIMIT) {
      timerEl.classList.add("red");
      if (!alarmPlayed) {
        audio.currentTime = 0;
        audio.play();
        alarmPlayed = true;
      }
    } else {
      timerEl.classList.remove("red");
    }
  }

  bladeInput.addEventListener("input", () => {
    startBtn.disabled = !/^\d{4}$/.test(bladeInput.value);
  });

  startBtn.addEventListener("click", () => {
    paleStat.textContent = "Pale : " + bladeInput.value;
    seconds = 0; 
    timerEl.textContent = "00:00:00";
    timerEl.classList.remove("red");
    alarmPlayed = false;
    timerInterval = setInterval(tick, 1000);
    document.getElementById("bladeContainer").style.display = "none";
    stopBtn.style.display = "inline-block";
  });

  stopBtn.addEventListener("click", () => {
    if (Date.now() < lockoutUntil) { alert("Locked out"); return; }
    popupOverlay.style.display = "flex";
    passwordInput.value = ""; confirmPassword.disabled = true; popupMsg.textContent = "";
  });

  passwordInput.addEventListener("input", () => {
    confirmPassword.disabled = passwordInput.value.trim().length === 0;
  });

  confirmPassword.addEventListener("click", () => {
    if (passwordInput.value === PASSWORD) {
      clearInterval(timerInterval); timerInterval = null;
      runs.push(seconds); updateStats();
      timerEl.textContent = "00:00:00"; timerEl.classList.remove("red");
      paleStat.textContent = "Pale :";
      document.getElementById("bladeContainer").style.display = "flex";
      bladeInput.value = ""; startBtn.disabled = true; stopBtn.style.display = "none";
      popupOverlay.style.display = "none";
      failCount = 0;
    } else {
      failCount++; passwordInput.value = ""; confirmPassword.disabled = true;
      if (failCount >= 3) {
        popupMsg.textContent = `Trop d'essais. VerrouillÃ© 1min.`;
        lockoutUntil = Date.now() + LOCKOUT_SECONDS * 1000;
        setTimeout(() => { popupOverlay.style.display = "none"; }, 2500);
        stopBtn.disabled = true;
        setTimeout(() => { stopBtn.disabled = false; failCount = 0; }, LOCKOUT_SECONDS * 1000);
      } else {
        popupMsg.textContent = `Incorrect. Essais restants: ${3 - failCount}`;
      }
    }
  });

  cancelPassword.addEventListener("click", () => {
    popupOverlay.style.display = "none";
  });

  // Secret reset shortcut: press C + L + R together
  const pressedKeys = new Set();
  document.addEventListener("keydown", (e) => {
    pressedKeys.add(e.key.toLowerCase());
    if (pressedKeys.has("c") && pressedKeys.has("l") && pressedKeys.has("r")) {
      runs = [];
      updateStats();
      localStorage.removeItem("cycleStats");
      console.log("Stats reset via C+L+R");
    }
  });
  document.addEventListener("keyup", (e) => {
    pressedKeys.delete(e.key.toLowerCase());
  });
</script>

</body>
</html>
