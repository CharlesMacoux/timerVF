<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cycle Time</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Font imports */
    @font-face {
      font-family: 'SonsCondensed';
      src: url('fonts/SonsCondensed-Semibold.ttf') format('truetype');
      font-weight: 600;
      font-style: normal;
    }
    @font-face {
      font-family: 'SonsCondensedExtra';
      src: url('fonts/SonsCondensed-Extrabold.ttf') format('truetype');
      font-weight: 800;
      font-style: normal;
    }
    @font-face {
      font-family: 'Inter';
      src: url('fonts/Inter-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
    }

    :root{
      --green: #c8ff08;
      --teal:  #005E60;
      --btn-hover: #a6d607;
    }

    html,body{height:100%; margin:0;}
    body{
      background:var(--teal);
      color:var(--green);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    #banner{
      width:100%;
      height:15vh;
      max-height:180px;
      object-fit:contain;
      background:var(--teal);
      display:block;
    }

    /* Stats text uses SonsCondensed */
    #stats, #statsLeft{
      position:absolute;
      top:40px;
      font-size:6vh;
      color:#fff;
      line-height:1.02;
      font-family:'SonsCondensed', sans-serif;
    }
    #stats{ right:20px; text-align:right; }
    #statsLeft{ left:20px; text-align:left; }

    #main{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:100%;
      box-sizing:border-box;
      padding:1vh 2vw;
    }

    /* Timer uses SonsCondensedExtra */
    #timer{
      display:inline-block;
      font-size:50vh;
      font-weight:800;
      color:var(--green);
      line-height:1;
      font-family:'SonsCondensedExtra','Courier New',monospace;
      font-variant-numeric: tabular-nums;
      text-align:left;
      min-width:7.05ch;
      margin:0 0 20px 0;
      transition: color .18s ease, -webkit-text-stroke .18s ease, text-shadow .18s ease;
      -webkit-text-stroke: 0px black;
      text-shadow: none;
    }
    #timer.red{
      color:red;
      -webkit-text-stroke: 1px black;
      text-shadow:
         -0.5px -0.5px 0 black,
          0.5px -0.5px 0 black,
         -0.5px  0.5px 0 black,
          0.5px  0.5px 0 black;
    }

    /* Blade input + Start (Inter font) */
    #bladeContainer{
      display:flex;
      align-items:center;
      gap:1vw;
      margin-top:1vh;
    }
    #bladeInput,
    #startBladeBtn{
      font-size:2.5vh;
      height:6vh;
      min-height:40px;
      padding:0 2vh;
      border-radius:1vh;
      border:none;
      box-sizing:border-box;
      font-family:'Inter', sans-serif;
    }
    #bladeInput{ width:12ch; text-align:center; outline:none; }
    #startBladeBtn{
      background:var(--green);
      color:var(--teal);
      cursor:pointer;
    }
    #startBladeBtn[disabled]{opacity:.45; cursor:not-allowed;}
    #startBladeBtn:hover:not([disabled]){ background:var(--btn-hover); }

    #stopBtn{
      height:6vh;
      min-height:40px;
      padding:0 2vh;
      font-size:2.5vh;
      border-radius:1vh;
      border:none;
      background:var(--green);
      color:var(--teal);
      cursor:pointer;
      display:none;
      margin-top:1.5vh;
      font-family:'Inter', sans-serif;
    }
    #stopBtn:hover:enabled{ background:var(--btn-hover); }
    #stopBtn:disabled{ opacity:.5; cursor:not-allowed; }

    /* Password popup (Inter font) */
    #popupOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:9999;
    }
    #popup{
      background:white;
      padding:18px 20px;
      border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
      text-align:center;
      min-width:260px;
      font-family:'Inter', sans-serif;
    }
    #popup p{ margin:0 0 10px 0; font-size:1.05rem; color:#222; }
    #passwordInput{ padding:8px 10px; font-size:1rem; width:70%; }
    #popupButtons{ margin-top:12px; display:flex; gap:10px; justify-content:center; }
    #popupButtons button{ padding:8px 14px; font-size:1rem; cursor:pointer; }
    #pwError{ color:#b00; min-height:1.2em; margin-top:8px; }

    @media (max-width:420px){
      #timer{ font-size:30vh; }
      #stats, #statsLeft{ font-size:4.8vh; }
    }
  </style>
</head>
<body>
  <img id="banner" src="images/gebanner3.jpg" alt="GE Banner">

  <div id="statsLeft"><div id="bladeNo">Pale --</div></div>
  <div id="stats">
    <div id="average">Moyenne : --:--:--</div>
    <div id="best">Meilleur : --:--:--</div>
    <div id="target">Cible : 24:00:00</div>
  </div>

  <div id="main">
    <div id="timer">00:00:00</div>
    <div id="bladeContainer">
      <input id="bladeInput" inputmode="numeric" maxlength="4" placeholder="Pale">
      <button id="startBladeBtn" disabled>Démarrer</button>
    </div>
    <button id="stopBtn">Arrêter</button>
  </div>

  <div id="popupOverlay">
    <div id="popup">
      <p>Veuillez entrer le mot de passe :</p>
      <input id="passwordInput" type="password" maxlength="10">
      <div id="popupButtons">
        <button id="confirmPasswordBtn">Confirmer</button>
        <button id="cancelPasswordBtn">Annuler</button>
      </div>
      <div id="pwError"></div>
    </div>
  </div>

  <script>
    const TIME_LIMIT = 24; // test in seconds
    const LOCKOUT_SECONDS = 60;
    const PASSWORD = "4321";

    let seconds=0, timerInterval=null, runs=[], failCount=0, lockoutUntil=0;

    const timerEl=document.getElementById("timer");
    const bladeInput=document.getElementById("bladeInput");
    const startBladeBtn=document.getElementById("startBladeBtn");
    const stopBtn=document.getElementById("stopBtn");
    const bladeNoEl=document.getElementById("bladeNo");
    const averageEl=document.getElementById("average");
    const bestEl=document.getElementById("best");
    const popupOverlay=document.getElementById("popupOverlay");
    const passwordInput=document.getElementById("passwordInput");
    const confirmPasswordBtn=document.getElementById("confirmPasswordBtn");
    const cancelPasswordBtn=document.getElementById("cancelPasswordBtn");
    const pwError=document.getElementById("pwError");

    function pad(n){return String(n).padStart(2,"0");}
    function formatTime(s){
      let h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;
      return `${pad(h)}:${pad(m)}:${pad(sec)}`;
    }

    function updateTimerTick(){
      seconds++;
      timerEl.textContent=formatTime(seconds);
      if(seconds>=TIME_LIMIT) timerEl.classList.add("red");
      else timerEl.classList.remove("red");
    }

    function updateStats(){
      if(!runs.length){
        averageEl.textContent="Moyenne : --:--:--";
        bestEl.textContent="Meilleur : --:--:--";
        return;
      }
      let total=runs.reduce((a,b)=>a+b,0),avg=Math.floor(total/runs.length),best=Math.min(...runs);
      averageEl.textContent="Moyenne : "+formatTime(avg);
      bestEl.textContent="Meilleur : "+formatTime(best);
    }

    bladeInput.addEventListener("input",()=>{
      startBladeBtn.disabled=!/^\d{4}$/.test(bladeInput.value.trim());
    });

    startBladeBtn.addEventListener("click",()=>{
      let val=bladeInput.value.trim();
      if(!/^\d{4}$/.test(val))return;
      bladeNoEl.textContent="Pale "+val;
      seconds=0;timerEl.textContent="00:00:00";timerEl.classList.remove("red");
      timerInterval=setInterval(updateTimerTick,1000);
      document.getElementById("bladeContainer").style.display="none";
      stopBtn.style.display="inline-block";stopBtn.disabled=false;
    });

    stopBtn.addEventListener("click",()=>{
      if(Date.now()<lockoutUntil){alert("Locked out.");return;}
      popupOverlay.style.display="flex";passwordInput.value="";pwError.textContent="";
      setTimeout(()=>passwordInput.focus(),50);
    });

    confirmPasswordBtn.addEventListener("click",()=>{
      if(Date.now()<lockoutUntil)return;
      if(passwordInput.value===PASSWORD){
        clearInterval(timerInterval);timerInterval=null;
        runs.push(seconds);updateStats();
        seconds=0;timerEl.textContent="00:00:00";timerEl.classList.remove("red");
        document.getElementById("bladeContainer").style.display="flex";
        bladeInput.value="";startBladeBtn.disabled=true;
        stopBtn.style.display="none";
        popupOverlay.style.display="none";
        failCount=0;
      }else{
        failCount++;
        let left=3-failCount;
        if(left>0){pwError.textContent=`Mot de passe incorrect. Essais restants: ${left}`;}
        else{
          lockoutUntil=Date.now()+LOCKOUT_SECONDS*1000;
          pwError.textContent=`Trop d'essais. Verrouillé pour 1 min.`;
          setTimeout(()=>{popupOverlay.style.display="none";},2500);
          stopBtn.disabled=true;
          let interval=setInterval(()=>{
            if(Date.now()>=lockoutUntil){
              clearInterval(interval);
              stopBtn.disabled=false;failCount=0;
            }
          },1000);
        }
      }
    });

    cancelPasswordBtn.addEventListener("click",()=>{
      popupOverlay.style.display="none";
    });

    passwordInput.addEventListener("keydown",e=>{
      if(e.key==="Enter")confirmPasswordBtn.click();
    });

    (function init(){
      timerEl.textContent="00:00:00";updateStats();
    })();
  </script>
</body>
</html>
