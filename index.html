<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Timer Synchro Firebase</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #timer { font-size: 2em; margin-bottom: 10px; }
  .red { color: red; }
  input.muted { opacity: 0.5; }
  .step-row { display: flex; align-items: center; margin-bottom: 4px; }
  .drag-handle { cursor: grab; margin-right: 4px; }
  .controlBtn { margin-left: 4px; }
</style>
</head>
<body>

<div id="timer">00:00:00</div>
<div id="stepLabel"></div>
<div id="bladeContainer">
  <input id="bladeInput" placeholder="Pale">
  <button id="startBtn" disabled>Démarrer</button>
</div>
<div id="paleRow" style="display:none;">
  <input id="paleInlineInput" style="display:none;">
  <button id="stopBtn">Arrêter</button>
</div>

<div id="stepsEditor"></div>
<button id="addStep">Ajouter Step</button>
<button id="sortStepEnds">Trier Steps</button>
<button id="preset1">Preset 47.3</button>
<button id="preset2">Preset 62.2</button>

<div id="historiquePopup" class="hidden">
  <table id="historiqueTableBody"></table>
  <button id="copyHistorique">Copier</button>
  <button id="resetHistorique">Réinitialiser</button>
  <button id="closeHistorique">Fermer</button>
</div>

<div id="settingsOverlay" style="display:none;">
  <input id="typeInput">
  <input id="paleInput">
  <input id="mouleInput">
  <input id="targetHours"><input id="targetMinutes"><input id="targetSeconds">
  <input id="currentHours"><input id="currentMinutes"><input id="currentSeconds">
  <button id="saveSettings">Sauvegarder</button>
  <button id="closeSettings">Fermer</button>
  <div id="advancedSection" style="display:none;">
    <div id="stepsEditor"></div>
  </div>
  <button id="toggleAdvancedBtn">Advanced</button>
</div>

<div id="popupOverlay" style="display:none;">
  <input id="passwordInput" type="password">
  <button id="confirmPassword">OK</button>
  <button id="cancelPassword">Annuler</button>
  <div id="popupMsg"></div>
</div>

<button id="fullscreenBtn"><img id="fullscreenIcon" src="" alt="Fullscreen"></button>
<button id="settingsBtn">Settings</button>
<button id="historiqueBtn">Historique</button>
<button id="infoBtn">Info</button>

<a id="openGuide" href="#">Guide PDF</a>
<div id="infoPopup" class="hidden">
  <button id="closeInfo">Fermer</button>
</div>

<audio id="alarmSound" src="alarm.mp3"></audio>

<script type="module">
// ====== Firebase Initialization ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJ-2de7M8XQEgRof6P7vhoRYIAZeR9ztE",
  authDomain: "timer-76fc8.firebaseapp.com",
  databaseURL: "https://timer-76fc8-default-rtdb.firebaseio.com",
  projectId: "timer-76fc8",
  storageBucket: "timer-76fc8.appspot.com",
  messagingSenderId: "15338816600",
  appId: "1:15338816600:web:9d571004f255dada7e762d",
  measurementId: "G-DKT62SZBHE"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ====== Global State ======
let running = false;
let tickTimeoutId = null;
let startTimestamp = null;
let displayedPresetSec = null;
let alarmPlayed = false;
let config = {};
let timerHistory = [];
let sessionValidUntil = 0;
const SESSION_DURATION = 5*60*1000;
const PASSWORD = "1234";
let failCount = 0;
let lockoutUntil = 0;
let unlockC = null;

// ====== DOM Elements ======
const timerEl = document.getElementById('timer');
const stepLabelEl = document.getElementById('stepLabel');
const bladeInput = document.getElementById('bladeInput');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const paleInlineInput = document.getElementById('paleInlineInput');
const stepsEditor = document.getElementById('stepsEditor');
const addStep = document.getElementById('addStep');
const sortStepEnds = document.getElementById('sortStepEnds');
const preset1 = document.getElementById('preset1');
const preset2 = document.getElementById('preset2');
const historiqueTableBody = document.getElementById('historiqueTableBody');
const copyHistorique = document.getElementById('copyHistorique');
const resetHistorique = document.getElementById('resetHistorique');

// ====== Helper Functions ======
function formatHMS(sec) {
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  return [h,m,s].map(x=>String(x).padStart(2,'0')).join(':');
}
function parseHMSParts(h,m,s){return (parseInt(h)||0)*3600 + (parseInt(m)||0)*60 + (parseInt(s)||0);}
function secondsToHMS(sec){ return {h:Math.floor(sec/3600), m:Math.floor(sec%3600/60), s:sec%60}; }

// ====== Firebase sync ======
const timerRef = ref(db,'timer');
onValue(timerRef, (snapshot) => {
  const data = snapshot.val();
  if(data){
    running = data.running || false;
    startTimestamp = data.startTimestamp || null;
    config = data.config || {};
    timerHistory = data.history || [];
    updateTimerDisplayFromFirebase();
  }
});

function updateFirebaseTimer(){
  set(timerRef, { running, startTimestamp, config, history: timerHistory });
}

function updateTimerDisplayFromFirebase(){
  if(startTimestamp){
    const elapsed = Math.floor((Date.now() - startTimestamp)/1000);
    timerEl.textContent = formatHMS(elapsed);
  }
}

// ====== Timer logic ======
function scheduleTick(){
  if(!running) return;
  tick();
  const msSinceStart = Date.now() - startTimestamp;
  const nextTick = 1000 - (msSinceStart % 1000) || 1000;
  tickTimeoutId = setTimeout(scheduleTick,nextTick);
}
function tick(){
  if(!running) return;
  const elapsed = Math.floor((Date.now() - startTimestamp)/1000);
  timerEl.textContent = formatHMS(elapsed);
  if(elapsed >= (config.targetSec||0)){
    timerEl.classList.add('red');
    if(!alarmPlayed){
      alarmPlayed=true;
      try { document.getElementById('alarmSound').play().catch(()=>{}); } catch(e){}
    }
  } else timerEl.classList.remove('red');
}

// ====== Start / Stop ======
startBtn.addEventListener('click',()=>{
  if(!bladeInput.value) return;
  config.pale = bladeInput.value.replace(/\D/g,'');
  bladeInput.value='';
  startBtn.disabled=true;
  stopBtn.style.display='inline-block';
  document.getElementById('paleRow').style.display='flex';
  startTimestamp = Date.now();
  running = true;
  alarmPlayed=false;
  scheduleTick();
  updateFirebaseTimer();
});
stopBtn.addEventListener('click',()=>{
  running=false;
  tickTimeoutId && clearTimeout(tickTimeoutId);
  tickTimeoutId=null;
  timerEl.textContent='00:00:00';
  timerEl.classList.remove('red');
  startTimestamp=null;
  updateFirebaseTimer();
});

// ====== Pale Inline ======
paleInlineInput.addEventListener('input',()=>{
  config.pale = paleInlineInput.value.replace(/\D/g,'');
  updateFirebaseTimer();
});

// ====== Presets ======
preset1.addEventListener('click',()=>{ config.type="47.3"; config.targetSec=24*3600; updateFirebaseTimer(); });
preset2.addEventListener('click',()=>{ config.type="62.2"; config.targetSec=30*3600; updateFirebaseTimer(); });

// ====== Historique ======
function addTimerEntry(startTime,durationSec){
  timerHistory.push({ pale: config.pale||'N/A', duration: formatHMS(durationSec) });
  if(timerHistory.length>200) timerHistory = timerHistory.slice(-200);
  updateFirebaseTimer();
}
copyHistorique.addEventListener('click',()=>{
  const csv = timerHistory.map(e=>`${e.pale}\t${e.duration}`).join('\n');
  navigator.clipboard.writeText(csv);
});
resetHistorique.addEventListener('click',()=>{ timerHistory=[]; updateFirebaseTimer(); });

// ====== Init ======
function init(){
  bladeInput.focus();
}
init();

</script>
</body>
</html>
